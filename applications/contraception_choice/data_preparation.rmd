---
title: "Data preparation of pairfam"
author: "Lennart Oelschl√§ger"
date: "`r Sys.Date()`"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

The purpose of this document is to prepare the pairfam dataset for modeling contraception choice.

## The pairfam dataset

*Pairfam* means *Panel Analysis of Intimate Relationships and Family Dynamics* and is a longitudinal study of German family processes. The data is collected annually via surveys from a nationwide random sample of 12,402 persons of the three birth cohorts 1971-73, 1981-83, 1991-93 and their partners, parents and children (multi-actor study). Main respondents are called anchors. 

## Read SPSS data and save in R-format

```{r}
### save data of each wave (11) as one list element
data <- list()
for(wave in 1:11){
  ### path to achors of the 'wave'th wave
  path <- paste0("data/SPSS/English/anchor",wave,".sav")
  ### convert from SPSS to R
  data[[wave]] <- foreign::read.spss(file = path, to.data.frame = TRUE)
  ### save columns as character except for id column
  data[[wave]][,-1] <- dplyr::mutate_all(data[[wave]][,-1], as.character)
}
### bind rows of waves together
data <- dplyr::bind_rows(data)
### sort rows by id
data <- dplyr::arrange(data, id)
### save data
saveRDS(data, "data/data_from_spss.rds")
```

### Filter for relevant covariates

```{r}
data <- readRDS("data/data_from_spss.rds")
data <- dplyr::select(data,
  id, # person id
  wave, # wave number
  age, # age
  sex_gen, # sex
  relstat, # relation status
  sex5, # use of contraception
  sex6i1,sex6i2,sex6i3,sex6i4,sex6i5,sex6i6,sex6i7,sex6i8,sex6i9,sex6i10,sex6i11, # contraception methods
  frt7 # intention to become mother/father within next 2 years
)
saveRDS(data,"data/data_filtered.rds")
```

### Encode covariates

```{r}
data <- readRDS("data/data_filtered.rds")

### id
data$id <- as.numeric(data$id)

### age
data$age <- as.numeric(data$age)

### Gender: M (male), F (female)
data[, "sex_gen"] <- as.factor(data[["sex_gen"]])
levels(data[, "sex_gen"])[levels(data[, "sex_gen"]) == "1 Male"] <- "M"
levels(data[, "sex_gen"])[levels(data[, "sex_gen"]) == "2 Female"] <- "F"

### Relationship status
### Covariate: relstat
### Original levels: 
### -  1 Never married single
### -  2 Never married living apart together
### -  3 Never married cohabiting
### -  4 Married cohabiting
### -  5 Married noncohabiting
### -  6 Divorced/separated single
### -  7 Divorced/separated living apart together
### -  8 Divorced/separated cohabiting
### -  9 Widowed single
### - 10 Widowed living apart together
### - 11 Widowed cohabiting
### New levels: 
### -  0 single (1, 6, 7, 9)
### -  1 relationship (2, 3, 4, 5, 8, 10, 11)
for(row in 1:nrow(data)){
  x <- as.numeric(stringr::str_extract(data[row,"relstat"],"[[:digit:]]+"))
  if(x %in% c(2,3,4,5,8,10,11)){
    data[row,"relstat"] <- 1
  } else if(x %in% c(1,6,7,9)){
    data[row,"relstat"] <- 0
  } else {
    data[row,"relstat"] <- NA
  }
}
data[,"relstat"] <- as.numeric(data[,"relstat"])

### Contraception: Did you or your partner use some form of contraception in the past three months? 
### Covariate: sex5
### Levels: 
### - 1 (yes)
### - 2 (no)
### New covariate: cu (contraception usage)
### New levels:
### Levels: 
### - 0 (no)
### - 1 (yes)
for(row in 1:nrow(data)){
  data[row,"sex5"] <- stringr::str_extract(data[row,"sex5"],"[[:digit:]]+")
}
data[,"cu"] <- as.numeric(data[,"sex5"])
data <- dplyr::mutate(data, cu = replace(sex5, sex5==2, 0))
data <- dplyr::select(data, !sex5)

### Contraception methods: What method(s) did you use primarily? Multiple answers are possible.
### Covariates (each level 0: not mentioned and 1: mentioned):
### - Birth control pill, mini-pill (sex6i1)
### - Condom (sex6i2)
### - Hormone preparations (sex6i3)
### - Intrauterine devise (IUD) (sex6i4)
### - Diaphragm, foam, suppository, gel (sex6i5)
### - Natural birth control (standard days method, rhythm method) (sex6i6)
### - Hysterectomy/female sterilization (sex6i7)
### - Vasectomy/male sterilization (sex6i8)
### - Withdrawal method, coitus interruptus (sex6i9)
### - The morning-after pill (sex6i10)
### - Something else (sex6i11)
### New covariates:
### - cm (levels: combination of '*' in 'sex6i*' and '0' for none)
### - pill (levels: 1 if 'sex6i1' is 1 and 0 else)
### - condom (levels: 1 if 'sex6i2' is 1 and 0 else)
contraception_cov <- paste0("sex6i",1:11)
for(row in 1:nrow(data)){
  for(cov in contraception_cov){
    data[row,cov] <- stringr::str_extract(data[row,cov],"[[:digit:]]+")
  }
}
for(cov in contraception_cov){
  data[,cov] <- as.numeric(data[,cov])
}
for(row in 1:nrow(data)){
  cm <- paste(which(data[row,contraception_cov]==1), collapse = "|")
  if(cm == "") cm <- "0"
  data[row,"cm"] <- cm
}
data[, "pill"] <- data[, "sex6i1"]
data[, "condom"] <- data[, "sex6i2"]
data <- dplyr::select(data, !contraception_cov)

### Intention to become mother/father within next 2 years
### Covariate: frt7
### Original levels: 
### -  1 Yes, definitely
### -  2 Yes, perheps
### -  3 No, probably not
### -  4 No, definitely not
### -  7 I haven't thought about that yet
### New levels: 
### -  1 yes (1, 2)
### -  0 no (3, 4)
for(row in 1:nrow(data)){
  x <- as.numeric(stringr::str_extract(data[row,"frt7"],"[[:digit:]]+"))
  if(x %in% c(1,2)){
    data[row,"frt7"] <- 1
  } else if(x %in% c(3,4)){
    data[row,"frt7"] <- 0
  } else {
    data[row,"frt7"] <- NA
  }
}
data[,"frt7"] <- as.numeric(data[,"frt7"])

saveRDS(data,"data/data_encoded.rds")
```

## Overview

```{r}
str(data)
```

## Checks
