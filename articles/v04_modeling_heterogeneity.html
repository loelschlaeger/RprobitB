<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="RprobitB">
<title>Modeling heterogeneity • RprobitB</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Modeling heterogeneity">
<meta property="og:description" content="RprobitB">
<meta property="og:image" content="https://loelschlaeger.de/RprobitB/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">RprobitB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/RprobitB.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/v01_model_definition.html">Model definition</a>
    <a class="dropdown-item" href="../articles/v02_choice_data.html">Choice data</a>
    <a class="dropdown-item" href="../articles/v03_model_fitting.html">Model fitting</a>
    <a class="dropdown-item" href="../articles/v04_modeling_heterogeneity.html">Modeling heterogeneity</a>
    <a class="dropdown-item" href="../articles/v05_choice_prediction.html">Choice prediction</a>
    <a class="dropdown-item" href="../articles/v06_model_selection.html">Model selection</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/loelschlaeger/RprobitB/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Modeling heterogeneity</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/loelschlaeger/RprobitB/blob/HEAD/vignettes/v04_modeling_heterogeneity.Rmd" class="external-link"><code>vignettes/v04_modeling_heterogeneity.Rmd</code></a></small>
      <div class="d-none name"><code>v04_modeling_heterogeneity.Rmd</code></div>
    </div>

    
    
<p>In the vignette on the model definition, we pointed out that the
probit model can capture choice behavior heterogeneity by imposing a
mixing distribution on the coefficient vector. The implementation in
{RprobitB} is explained in this vignette<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;This vignette is built using R 4.2.3 with the {RprobitB}
1.1.2 package.&lt;/p&gt;"><sup>1</sup></a>.</p>
<div class="section level2">
<h2 id="estimating-a-joint-normal-mixing-distribution">Estimating a joint normal mixing distribution<a class="anchor" aria-label="anchor" href="#estimating-a-joint-normal-mixing-distribution"></a>
</h2>
<p>The {mlogit} package <span class="citation">(<a href="#ref-Croissant:2020" role="doc-biblioref">Croissant
2020</a>)</span> contains the data set <code>Electricity</code>, in
which residential electricity customers were asked to decide between
four hypothetical electricity suppliers. The suppliers differed in 6
characteristics:</p>
<ol style="list-style-type: decimal">
<li>their fixed price <code>pf</code> per kWh,</li>
<li>their contract length <code>cf</code>,</li>
<li>a boolean <code>loc</code>, indicating whether the supplier is a
local company,</li>
<li>a boolean <code>wk</code>, indicating whether the supplier is a well
known company,</li>
<li>a boolean <code>tod</code>, indicating whether the supplier offers a
time-of-day electricity price (which is higher during the day and lower
during the night), and</li>
<li>a boolean <code>seas</code>, indicating whether the supplier’s price
is seasonal dependent.</li>
</ol>
<p>This constitutes a choice situation where choice behavior
heterogeneity is expected: some customers might prefer a time-of-day
electricity price (because they may be not at home during the day),
while others can have the opposite preference. Ideally these differences
in preferences should be modeled using characteristics of the deciders.
In many cases (as in this data set) we do not have adequate information.
Instead these differences in taste can be captured by means of a mixing
distribution for the <code>tod</code> coefficient. This corresponds to
the assumption of a random coefficient from the underlying mixing
distribution to be drawn for each decider. We can use the estimated
mixing distribution to determine for example the share of deciders that
have a positive versus negative preference towards time-of-day
electricity prices.</p>
<p>Additionally, we expect correlations between the random coefficients
to certain covariates, for example a positive correlation between the
influence of <code>loc</code> and <code>wk</code>: deciders that prefer
local suppliers might also prefer well known companies due to
recommendations and past experiences, although they might be more
expensive than unknown suppliers. The fitted multivariate normal
distribution will reveal these correlations.</p>
<p>The following lines prepare the <code>Electricity</code> data set for
estimation. We use the convenience function <code><a href="../reference/as_cov_names.html">as_cov_names()</a></code>
that relabels the data columns for alternative specific covariates into
the required format
“<code>&lt;covariate&gt;_&lt;alternative&gt;</code>”, compare to the
vignette on choice data. Via the
<code>re = c("cl","loc","wk","tod","seas")</code> argument, we specify
that we want to model random effects for all but the price coefficient,
which we will fix to <code>-1</code> to interpret the other estimates as
monetary values.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"Electricity"</span>, package <span class="op">=</span> <span class="st">"mlogit"</span><span class="op">)</span></span>
<span><span class="va">Electricity</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_cov_names.html">as_cov_names</a></span><span class="op">(</span><span class="va">Electricity</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pf"</span>,<span class="st">"cl"</span>,<span class="st">"loc"</span>,<span class="st">"wk"</span>,<span class="st">"tod"</span>,<span class="st">"seas"</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span></span>
<span>  form <span class="op">=</span> <span class="va">choice</span> <span class="op">~</span> <span class="va">pf</span> <span class="op">+</span> <span class="va">cl</span> <span class="op">+</span> <span class="va">loc</span> <span class="op">+</span> <span class="va">wk</span> <span class="op">+</span> <span class="va">tod</span> <span class="op">+</span> <span class="va">seas</span> <span class="op">|</span> <span class="fl">0</span>,</span>
<span>  choice_data <span class="op">=</span> <span class="va">Electricity</span>,</span>
<span>  re <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cl"</span>,<span class="st">"loc"</span>,<span class="st">"wk"</span>,<span class="st">"tod"</span>,<span class="st">"seas"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_elec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">data</span>, R <span class="op">=</span> <span class="fl">1000</span>, scale <span class="op">=</span> <span class="st">"pf := -1"</span><span class="op">)</span></span></code></pre></div>
<p>Calling the <code><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef()</a></code> method on the estimated model also
returns the estimated (marginal) variances of the mixing distribution
besides the average mean effects:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">model_elec</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Estimate   (sd) Variance   (sd)</span></span>
<span><span class="co">#&gt; 1   pf     -1.00 (0.00)       NA   (NA)</span></span>
<span><span class="co">#&gt; 2   cl     -0.25 (0.03)     0.30 (0.03)</span></span>
<span><span class="co">#&gt; 3  loc      2.75 (0.25)     6.61 (1.33)</span></span>
<span><span class="co">#&gt; 4   wk      2.02 (0.22)     3.52 (0.77)</span></span>
<span><span class="co">#&gt; 5  tod     -9.81 (0.25)    11.74 (2.21)</span></span>
<span><span class="co">#&gt; 6 seas     -9.87 (0.19)     5.94 (0.99)</span></span></code></pre></div>
<p>By the sign of the estimates we can for example deduce, that the
existence of the time-of-day electricity price <code>tod</code> in the
contract has a negative effect. However, the deciders are very
heterogeneous here, because the estimated variance of this coefficient
is large. The same holds for the contract length <code>cl</code>. In
particular, the estimated share of the population that prefers to have a
longer contract length equals:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl_mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">model_elec</span><span class="op">)</span><span class="op">[</span><span class="st">"cl"</span>,<span class="st">"mean"</span><span class="op">]</span></span>
<span><span class="va">cl_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">model_elec</span><span class="op">)</span><span class="op">[</span><span class="st">"cl"</span>,<span class="st">"var"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">cl_mu</span> <span class="op">/</span> <span class="va">cl_sd</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.322294</span></span></code></pre></div>
<p>The correlation between the covariates can be accessed as follows:<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Setting &lt;code&gt;cor = FALSE&lt;/code&gt; instead returns the
estimated covariance matrix.&lt;/p&gt;"><sup>2</sup></a></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cov_mix.html">cov_mix</a></span><span class="op">(</span><span class="va">model_elec</span>, cor <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;               cl        loc          wk         tod        seas</span></span>
<span><span class="co">#&gt; cl    1.00000000 0.12054515  0.09760942 -0.07360631 -0.12403999</span></span>
<span><span class="co">#&gt; loc   0.12054515 1.00000000  0.77769164  0.12450311  0.01283939</span></span>
<span><span class="co">#&gt; wk    0.09760942 0.77769164  1.00000000  0.12948417 -0.01680802</span></span>
<span><span class="co">#&gt; tod  -0.07360631 0.12450311  0.12948417  1.00000000  0.52915014</span></span>
<span><span class="co">#&gt; seas -0.12403999 0.01283939 -0.01680802  0.52915014  1.00000000</span></span></code></pre></div>
<p>Here, we see the confirmation of our initial assumption about a high
correlation between <code>loc</code> and <code>wk</code>. The pairwise
mixing distributions can be visualized via calling the
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method with the additional argument
<code>type = mixture</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model_elec</span>, type <span class="op">=</span> <span class="st">"mixture"</span><span class="op">)</span></span></code></pre></div>
<p><img src="img/plot-mixture-model-elec-1.png" width="75%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="estimating-latent-classes">Estimating latent classes<a class="anchor" aria-label="anchor" href="#estimating-latent-classes"></a>
</h2>
<p>More generally, {RprobitB} allows to specify a Gaussian mixture as
the mixing distribution. In particular,</p>
<p><span class="math display">\[ \beta \sim \sum_{c=1}^C \text{MVN}
(b_c,\Omega_c).\]</span> This specification allows for a) a better
approximation of the true underlying mixing distribution and b) a
preference based classification of the deciders.</p>
<p>To estimate a latent mixture, specify a named list
<code>latent_classes</code> with the following arguments and submit it
to the estimation routine <code>fit_model</code>:</p>
<ul>
<li><p><code>C</code>, the fixed number (greater or equal 1) of latent
classes, which is set to 1 per default, <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;If either &lt;code&gt;weight_update = TRUE&lt;/code&gt; or
&lt;code&gt;dp_update = TRUE&lt;/code&gt; (i.e. if classes are updated),
&lt;code&gt;C&lt;/code&gt; equals the initial number of latent classes.&lt;/p&gt;"><sup>3</sup></a></p></li>
<li><p><code>weight_update</code>, a boolean, set to <code>TRUE</code>
for a weight-based update of the latent classes, see below,</p></li>
<li><p><code>dp_update</code>, a boolean, set to <code>TRUE</code> for a
Dirichlet process-based update of the latent classes, see
below,</p></li>
<li><p><code>Cmax</code>, the maximum number of latent classes, set to
<code>10</code> per default.</p></li>
</ul>
<div class="section level3">
<h3 id="weight-based-update-of-the-latent-classes">Weight-based update of the latent classes<a class="anchor" aria-label="anchor" href="#weight-based-update-of-the-latent-classes"></a>
</h3>
<p>The following weight-based updating scheme is analogue to <span class="citation">Bauer, Büscher, and Batram (<a href="#ref-Bauer:2019" role="doc-biblioref">2019</a>)</span> and executed within the burn-in
period:</p>
<ul>
<li><p>We remove class <span class="math inline">\(c\)</span>, if <span class="math inline">\(s_c&lt;\varepsilon_{\text{min}}\)</span>, i.e. if
the class weight <span class="math inline">\(s_c\)</span> drops below
some threshold <span class="math inline">\(\varepsilon_{\text{min}}\)</span>. This case
indicates that class <span class="math inline">\(c\)</span> has a
negligible impact on the mixing distribution.</p></li>
<li><p>We split class <span class="math inline">\(c\)</span> into two
classes <span class="math inline">\(c_1\)</span> and <span class="math inline">\(c_2\)</span>, if <span class="math inline">\(s_c&gt;\varepsilon_\text{max}\)</span>. This case
indicates that class <span class="math inline">\(c\)</span> has a high
influence on the mixing distribution whose approximation can potentially
be improved by increasing the resolution in directions of high variance.
Therefore, the class means <span class="math inline">\(b_{c_1}\)</span>
and <span class="math inline">\(b_{c_2}\)</span> of the new classes
<span class="math inline">\(c_1\)</span> and <span class="math inline">\(c_2\)</span> are shifted in opposite directions
from the class mean <span class="math inline">\(b_c\)</span> of the old
class <span class="math inline">\(c\)</span> in the direction of the
highest variance.</p></li>
<li><p>We join two classes <span class="math inline">\(c_1\)</span> and
<span class="math inline">\(c_2\)</span> to one class <span class="math inline">\(c\)</span>, if <span class="math inline">\(\lVert
b_{c_1} - b_{c_2} \rVert&lt;\varepsilon_{\text{distmin}}\)</span>,
i.e. if the euclidean distance between the class means <span class="math inline">\(b_{c_1}\)</span> and <span class="math inline">\(b_{c_2}\)</span> drops below some threshold <span class="math inline">\(\varepsilon_{\text{distmin}}\)</span>. This case
indicates location redundancy which should be repealed. The parameters
of <span class="math inline">\(c\)</span> are assigned by adding the
values of <span class="math inline">\(s\)</span> from <span class="math inline">\(c_1\)</span> and <span class="math inline">\(c_2\)</span> and averaging the values for <span class="math inline">\(b\)</span> and <span class="math inline">\(\Omega\)</span>.</p></li>
</ul>
<p>These rules contain choices on the values for <span class="math inline">\(\varepsilon_{\text{min}}\)</span>, <span class="math inline">\(\varepsilon_{\text{max}}\)</span> and <span class="math inline">\(\varepsilon_{\text{distmin}}\)</span>. The
adequate value for <span class="math inline">\(\varepsilon_{\text{distmin}}\)</span> depends on
the scale of the parameters. Per default, {RprobitB} sets</p>
<ul>
<li><p><code>epsmin = 0.01</code>,</p></li>
<li><p><code>epsmax = 0.99</code>, and</p></li>
<li><p><code>distmin = 0.1</code>.</p></li>
</ul>
<p>These values can be adapted through the <code>latent_class</code>
list.</p>
</div>
<div class="section level3">
<h3 id="dirichlet-process-based-update-of-the-latent-classes">Dirichlet process-based update of the latent classes<a class="anchor" aria-label="anchor" href="#dirichlet-process-based-update-of-the-latent-classes"></a>
</h3>
<p>As an alternative to the weight-based updating scheme to determine
the correct number <span class="math inline">\(C\)</span> of latent
classes, {RprobitB} implemented the Dirichlet process.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;A similar approach in the context of discrete choice can
be found in &lt;span class="citation"&gt;Burda, Harding, and Hausman (&lt;a href="#ref-Burda:2008" role="doc-biblioref"&gt;2008&lt;/a&gt;)&lt;/span&gt;, where the
Dirichlet process is applied to estimate a mixed logit-probit model.&lt;/p&gt;'><sup>4</sup></a> The Dirichlet Process
is a Bayesian nonparametric method, where nonparametric means that the
number of model parameters can theoretically grow to infinity. The
method allows to add more mixture components to the mixing distribution
if needed for a better approximation, see <span class="citation">Neal
(<a href="#ref-Neal:2000" role="doc-biblioref">2000</a>)</span> for a
documentation of the general case. The literature offers many
representations of the method, including the Chinese Restaurant Process
<span class="citation">(<a href="#ref-Aldous:1985" role="doc-biblioref">Aldous 1985</a>)</span>, the stick-braking methapor
<span class="citation">(<a href="#ref-Sethuraman:1994" role="doc-biblioref">Sethuraman 1994</a>)</span>, and the Polya Urn
model <span class="citation">(<a href="#ref-Blackwell:1973" role="doc-biblioref">Blackwell and MacQueen 1973</a>)</span>.</p>
<p>In our case, we face the situation to find a distribution <span class="math inline">\(g\)</span> that explains the decider-specific
coefficients <span class="math inline">\((\beta_n)_{n =
1,\dots,N}\)</span>, where <span class="math inline">\(g\)</span> is
supposed to be a mixture of an unknown number <span class="math inline">\(C\)</span> of Gaussian densities, i.e. <span class="math inline">\(g = \sum_{c = 1,\dots,C} s_c \text{MVN}(b_c,
\Omega_c)\)</span>.</p>
<p>Let <span class="math inline">\(z_n \in \{1,\dots,C\}\)</span> denote
the class membership of <span class="math inline">\(\beta_n\)</span>. A
priori, the mixture weights <span class="math inline">\((s_c)_c\)</span>
are given a Dirichlet prior with concentration parameter <span class="math inline">\(\delta/C\)</span>, i.e. <span class="math inline">\((s_c)_c \mid \delta \sim
\text{D}_C(\delta/C,\dots,\delta/C)\)</span>. <span class="citation">Rasmussen (<a href="#ref-Rasmussen:2000" role="doc-biblioref">2000</a>)</span> shows that</p>
<p><span class="math display">\[ \Pr((z_n)_n\mid \delta) =
\frac{\Gamma(\delta)}{\Gamma(N+\delta)} \prod_{c=1}^C \frac{\Gamma(m_c +
\delta/C)}{\Gamma(\delta/C)}, \]</span> where <span class="math inline">\(\Gamma(\cdot)\)</span> denotes the gamma function
and <span class="math inline">\(m_c = \#\{n:z_n = c\}\)</span> the
number of elements that are currently allocated to class <span class="math inline">\(c\)</span>. Crucially, the last equation is
independent of the class weights <span class="math inline">\((s_c)_c\)</span>, yet it still depends on the
finite number <span class="math inline">\(C\)</span> of latent classes.
However, <span class="citation">Li, Schofield, and Gönen (<a href="#ref-Li:2019" role="doc-biblioref">2019</a>)</span> shows that</p>
<p><span class="math display">\[ \Pr(z_n = c \mid z_{-n}, \delta) =
\frac{m_{c,-n} + \delta/C}{N-1+\delta},\]</span> where the notation
<span class="math inline">\(-n\)</span> means excluding the <span class="math inline">\(n\)</span>th element. We can let <span class="math inline">\(C\)</span> approach infinity to derive:</p>
<p><span class="math display">\[ \Pr(z_n = c \mid z_{-n}, \delta) \to
\frac{m_{c,-n}}{N-1+\delta}. \]</span></p>
<p>Note that the allocation probabilities do not sum to 1, instead</p>
<p><span class="math display">\[ \sum_{c = 1}^C
\frac{m_{c,-n}}{N-1+\delta} = \frac{N-1}{N-1+\delta}. \]</span></p>
<p>The difference to 1 equals</p>
<p><span class="math display">\[ \Pr(z_n \neq z_m ~ \forall ~ m \neq n
\mid z_{-n}, \delta) = \frac{\delta}{N-1+\delta} \]</span></p>
<p>and constitutes the probability that a new cluster for observation
<span class="math inline">\(n\)</span> is created. <span class="citation">Neal (<a href="#ref-Neal:2000" role="doc-biblioref">2000</a>)</span> points out that this probability
is proportional to the prior parameter <span class="math inline">\(\delta\)</span>: A greater value for <span class="math inline">\(\delta\)</span> encourages the creation of new
clusters, a smaller value for <span class="math inline">\(\delta\)</span> increases the probability of an
allocation to an already existing class.</p>
<p>In summary, the Dirichlet process updates the allocation of each
<span class="math inline">\(\beta\)</span> coefficient vector one at a
time, dependent on the other allocations. The number of clusters can
theoretically rise to infinity, however, as we delete unoccupied
clusters, <span class="math inline">\(C\)</span> is bounded by <span class="math inline">\(N\)</span>. As a final step after the allocation
update, we update the class means <span class="math inline">\(b_c\)</span> and covariance matrices <span class="math inline">\(\Omega_c\)</span> by means of their posterior
predictive distribution. The mean and covariance matrix for a new
generated cluster is drawn from the prior predictive distribution. The
corresponding formulas are given in <span class="citation">Li,
Schofield, and Gönen (<a href="#ref-Li:2019" role="doc-biblioref">2019</a>)</span>.</p>
<p>The Dirichlet process directly integrates into our existing Gibbs
sampler. Given <span class="math inline">\(\beta\)</span> values, it
updated the class means <span class="math inline">\(b_c\)</span> and
class covariance matrices <span class="math inline">\(\Omega_c\)</span>.
The Dirichlet process updating scheme is implemented in the function
<code><a href="../reference/update_classes_dp.html">update_classes_dp()</a></code>. In the following, we give a small
example in the bivariate case <code>P_r = 2</code>. We sample true class
means <code>b_true</code> and class covariance matrices
<code>Omega_true</code> for <code>C_true = 3</code> true latent classes.
The true (unbalanced) class sizes are given by the vector
<code>N</code>, and <code>z_true</code> denotes the true
allocations.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">P_r</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">C_true</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">70</span>,<span class="fl">30</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">b_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">C_true</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">P_r</span><span class="op">)</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">P_r</span>, ncol <span class="op">=</span> <span class="va">C_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;            [,1]       [,2]       [,3]</span></span>
<span><span class="co">#&gt; [1,] -0.6264538 -0.8356286  0.3295078</span></span>
<span><span class="co">#&gt; [2,]  0.1836433  1.5952808 -0.8204684</span></span>
<span><span class="op">(</span><span class="va">Omega_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">C_true</span>, <span class="fu"><a href="../reference/rwishart.html">rwishart</a></span><span class="op">(</span><span class="va">P_r</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fl">0.1</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">P_r</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">W</span>, simplify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                      nrow <span class="op">=</span> <span class="va">P_r</span><span class="op">*</span><span class="va">P_r</span>, ncol <span class="op">=</span> <span class="va">C_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]        [,2]       [,3]</span></span>
<span><span class="co">#&gt; [1,] 0.3093652  0.14358543  0.2734617</span></span>
<span><span class="co">#&gt; [2,] 0.1012729 -0.07444148 -0.1474941</span></span>
<span><span class="co">#&gt; [3,] 0.1012729 -0.07444148 -0.1474941</span></span>
<span><span class="co">#&gt; [4,] 0.2648235  0.05751780  0.2184029</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">C_true</span><span class="op">)</span> <span class="kw">for</span><span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">[</span><span class="va">c</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">beta</span>, <span class="fu"><a href="../reference/rmvnorm.html">rmvnorm</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="va">b_true</span><span class="op">[</span>,<span class="va">c</span>,drop<span class="op">=</span><span class="cn">F</span><span class="op">]</span>, Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">Omega_true</span><span class="op">[</span>,<span class="va">c</span>,drop<span class="op">=</span><span class="cn">F</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="va">P_r</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">z_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, times <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span></code></pre></div>
<p>We specify the following prior parameters (for their definition see
the vignette on model fitting):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delta</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">xi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">P_r</span><span class="op">)</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">P_r</span><span class="op">)</span></span>
<span><span class="va">nu</span> <span class="op">&lt;-</span> <span class="va">P_r</span> <span class="op">+</span> <span class="fl">2</span></span>
<span><span class="va">Theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">P_r</span><span class="op">)</span></span></code></pre></div>
<p>Initially, we start with <code>C = 1</code> latent classes. The class
mean <code>b</code> is set to zero, the covariance matrix
<code>Omega</code> to the identity matrix:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">C</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">P_r</span>, ncol <span class="op">=</span> <span class="va">C</span><span class="op">)</span></span>
<span><span class="va">Omega</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">P_r</span><span class="op">)</span>, <span class="va">C</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">P_r</span><span class="op">*</span><span class="va">P_r</span>, ncol <span class="op">=</span> <span class="va">C</span><span class="op">)</span></span></code></pre></div>
<p>The following call to <code><a href="../reference/update_classes_dp.html">update_classes_dp()</a></code> updates the
latent classes in <code>100</code> iterations. Note that we specify the
arguments <code>Cmax</code> and <code>s_desc</code>. The former denotes
the maximum number of latent classes. This specification is not a
requirement for the Dirichlet process per se, but rather for its
implementation. Knowing the maximum possible class number, we can
allocate the required memory space, which leads to a speed improvement.
We later can verify that we won’t exceed the number of
<code>Cmax = 10</code> latent classes at any point of the Dirichlet
process. Setting <code>s_desc = TRUE</code> ensures that the classes are
ordered by their weights in a descending order to ensure
identifiability.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">dp</span> <span class="op">&lt;-</span> <span class="fu">RprobitB</span><span class="fu">:::</span><span class="fu"><a href="../reference/update_classes_dp.html">update_classes_dp</a></span><span class="op">(</span></span>
<span>    Cmax <span class="op">=</span> <span class="fl">10</span>, <span class="va">beta</span>, <span class="va">z</span>, <span class="va">b</span>, <span class="va">Omega</span>, <span class="va">delta</span>, <span class="va">xi</span>, <span class="va">D</span>, <span class="va">nu</span>, <span class="va">Theta</span>, s_desc <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="va">dp</span><span class="op">$</span><span class="va">z</span></span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="va">dp</span><span class="op">$</span><span class="va">b</span></span>
<span>  <span class="va">Omega</span> <span class="op">&lt;-</span> <span class="va">dp</span><span class="op">$</span><span class="va">Omega</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The Dirichlet process was able to infer the true number
<code>C_true = 3</code> of latent classes:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span>, xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></span>
<span><span class="fu">RprobitB</span><span class="fu">:::</span><span class="fu"><a href="../reference/plot_class_allocation.html">plot_class_allocation</a></span><span class="op">(</span><span class="va">beta</span>, <span class="va">z</span>, <span class="va">b</span>, <span class="va">Omega</span>, r <span class="op">=</span> <span class="fl">100</span>, perc <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></code></pre></div>
<p><img src="img/dirichlet-example-plot-1.png" width="75%" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Aldous:1985" class="csl-entry">
Aldous, D. J. 1985. <span>“Exchangeability and Related Topics,”</span>
Lecture notes in math., 1117: 1–198.
</div>
<div id="ref-Bauer:2019" class="csl-entry">
Bauer, D., S. Büscher, and M. Batram. 2019. <span>“Non-Parameteric
Estiation of Mixed Discrete Choice Models.”</span> <em>Second
International Choice Modelling Conference in Kobe</em>.
</div>
<div id="ref-Blackwell:1973" class="csl-entry">
Blackwell, D., and J. MacQueen. 1973. <span>“Ferguson Distributions via
Polya Urn Schemes.”</span> <em>The Annals of Statistics</em> 1: 353–55.
</div>
<div id="ref-Burda:2008" class="csl-entry">
Burda, M., M. Harding, and J. Hausman. 2008. <span>“A Bayesian Mixed
Logit–Probit Model for Multinomial Choice.”</span> <em>Journal of
Econometrics</em> 147 (2). <a href="https://doi.org/10.1016/j.jeconom.2008.09.029" class="external-link">https://doi.org/10.1016/j.jeconom.2008.09.029</a>.
</div>
<div id="ref-Croissant:2020" class="csl-entry">
Croissant, Y. 2020. <span>“Estimation of Random Utility Models in r: The
Mlogit Package.”</span> <em>Journal of Statistical Software</em> 95
(11). <a href="https://doi.org/10.18637/jss.v095.i11" class="external-link">https://doi.org/10.18637/jss.v095.i11</a>.
</div>
<div id="ref-Li:2019" class="csl-entry">
Li, Y., E. Schofield, and M. Gönen. 2019. <span>“A Tutorial on Dirichlet
Process Mixture Modeling.”</span> <em>Journal of Mathematical
Psychology</em> 91. <a href="https://doi.org/10.1016/j.jmp.2019.04.004" class="external-link">https://doi.org/10.1016/j.jmp.2019.04.004</a>.
</div>
<div id="ref-Neal:2000" class="csl-entry">
Neal, R. M. 2000. <span>“Markov Chain Sampling Methods for Dirichlet
Process Mixture Models.”</span> <em>Journal of Computational and
Graphical Statistics</em> 9 (2). <a href="https://doi.org/10.2307/1390653" class="external-link">https://doi.org/10.2307/1390653</a>.
</div>
<div id="ref-Rasmussen:2000" class="csl-entry">
Rasmussen, C. E. 2000. <em>The Infinite Gaussian Mixture Model</em>.
Vol. 12. MIT Press.
</div>
<div id="ref-Sethuraman:1994" class="csl-entry">
Sethuraman, J. 1994. <span>“A Constructive Definition of Dirichlet
Priors.”</span> <em>Statistica Sinica</em> 4 (2): 639–50. <a href="http://www.jstor.org/stable/24305538" class="external-link">http://www.jstor.org/stable/24305538</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://loelschlaeger.de" class="external-link">Lennart Oelschläger</a>, <a href="https://de.wikipedia.org/wiki/Dietmar_Bauer" class="external-link">Dietmar Bauer</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
