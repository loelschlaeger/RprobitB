---
title: "Documentation of Pairfam Project"
author: "Lennart OelschlC$ger"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warnings = FALSE, eval = FALSE)
library(dplyr)
library(ggplot2)
library(stringr)
library(reshape2)
```

## The "pairfam" dataset
"Pairfam" means "Panel Analysis of Intimate Relationships and Family Dynamics" and is a longitudinal study of German family processes. The data is collected annually via surveys from a nationwide random sample of 12,402 persons of the three birth cohorts 1971-73, 1981-83, 1991-93 and their partners, parents and children (multi-actor study). Main respondents are called anchors. 

## Read SPSS data and save in R-format
```{r}
data = list()
waves = 11
for(wave in 1:waves){
  ### convert from SPSS to R
  data[[wave]] = foreign::read.spss(paste0("data/SPSS/English/anchor",wave,".sav"), to.data.frame=TRUE)
  ### save columns as character except for id column
  data[[wave]][,-1] = mutate_all(data[[wave]][,-1],as.character)
}
### bind wave rows together
data = bind_rows(data)
### sort by id
data = arrange(data, id)
### save data
saveRDS(data,"data/data_from_spss.rds")
```

### Select relevant covariates
```{r}
data = readRDS("data/data_from_spss.rds")
data = data %>% select(id, # person id
                       age, # age
                       relstat, # relation status
                       sex5, # use of contraception
                       sex6i1,sex6i2,sex6i3,sex6i4,sex6i5,sex6i6,sex6i7,sex6i8,sex6i9,sex6i10,sex6i11 # contraception method
                       )
saveRDS(data,"data/data_filtered.rds")
```

### Encode covariates
```{r}
data = readRDS("data/data_filtered.rds")

### Relationstatus
### Covariate: relstat
### Levels: 0 (single), 1 (relationship)
for(row in 1:nrow(data)){
  x = as.numeric(str_extract(data[row,"relstat"],"[[:digit:]]+"))
  if(x %in% c(3,4,5,7,8,11)){
    data[row,"relstat"] = 1
  } else if(x %in% c(1,6,9)){
    data[row,"relstat"] = 0
  } else {
    data[row,"relstat"] = NA
  }
}
data[,"relstat"] = as.numeric(data[,"relstat"])

### Contraception: Did you or your partner use some form of contraception in the past three months? 
### Covariate: sex5
### Levels: 1 (yes), 2 (no)
for(row in 1:nrow(data)){
  data[row,"sex5"] = str_extract(data[row,"sex5"],"[[:digit:]]+")
}
data[,"sex5"] = as.numeric(data[,"sex5"])

### Contraception methods: What method(s) did you use primarily? Multiple answers are possible.
### Birth control pill, mini-pill (sex6i1)
### Condom (sex6i2)
### Hormone preparations (sex6i3)
### Intrauterine devise (IUD) (sex6i4)
### Diaphragm, foam, suppository, gel (sex6i5)
### Natural birth control (standard days method, rhythm method) (sex6i6)
### Hysterectomy/female sterilization (sex6i7)
### Vasectomy/male sterilization (sex6i8)
### Withdrawal method, coitus interruptus (sex6i9)
### The morning-after pill (sex6i10)
### Something else (sex6i11)
### Levels: 0 (not mentioned), 1 (mentioned)
contraception_cov = paste0("sex6i",1:11)
for(row in 1:nrow(data)){
  for(cov in contraception_cov){
    data[row,cov] = str_extract(data[row,cov],"[[:digit:]]+")
  }
}
for(cov in contraception_cov){
  data[,cov] = as.numeric(data[,cov])
}
for(row in 1:nrow(data)){
  cm = paste(which(data[row,contraception_cov]==1),collapse="_")
  if(cm == "") 
    cm = "none"
  data[row,"cm"] = cm
}

### age
data$age = as.numeric(data$age)

saveRDS(data,"data/data_encoded.rds")
```

### Histogram of contraception
```{r, eval = TRUE}
data = readRDS("data/data_encoded.rds")
ggplot(data, aes(sex5)) +
  scale_x_discrete(limits = c("1","2"), labels = c("yes","no")) +
  geom_bar() +
  theme_classic() +
  xlab("Did you or your partner use some form of contraception in the past three months?") +
  ylab("")
```

### Histogram of most frequent contraception method
```{r, eval = TRUE}
data = readRDS("data/data_encoded.rds")
ncon = 8
data = data %>% filter(cm != "none")
prom_con = names(sort(table(data$cm),decreasing=TRUE))[1:(ncon-1)]
for(row in 1:nrow(data)){
  if(!data[row,"cm"] %in% prom_con || data[row,"cm"] == "11") 
    data[row,"cm"] = "others"
}
ggplot(data, aes(cm)) +
  geom_bar() +
  theme_classic() +
  xlab("Choice of contraception") +
  ylab("")
```

### Select decision makers and choice set and model fit
```{r, eval=TRUE}
data = readRDS("data/data_encoded.rds")
data = data[complete.cases(data),]
data = filter(data, cm != "none")
data = filter(data, cm %in% c("1","2"))
data$choice = data$cm
data = data %>% select(id, choice, age, relstat)
data = prepare(form = choice ~ 0 | age + relstat + 1, choice_data = data, standardize = "age_1")
model = mcmc(data)
predict(model)
```
